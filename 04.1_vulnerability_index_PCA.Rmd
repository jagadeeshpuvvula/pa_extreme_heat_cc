---
title: "04_vulnerability_index"
author: "Puvvula"
date: "2024-04-25"
output: pdf_document
---

#load SDOH data
```{r}
load(paste0(direc, "SDOH_final.RDA"))
```

#select required variables to work
```{r}
index_df<- dat_fin |>
  as_tibble()|>
  select(c(4, 16:27)) |>
  rename(`Non-Hispanic Black` = blk_pct,
         Hispanic = hisp_pct,
         Asian = asin_pct,
         `Alaska/Pacific-Islander` = alask_pacf_isl_pct,
         `Health insurance` = ins_pct,
         `Federal assistance` =ssi_snap_pct,
         `Households in poverty` = poverty_pct,
         `Un-employment` = un_empl_pct,
         `Language barrier` = langu_pct,
         `Single parent` =sing_prnt_pct,
         `Foregin born` = foregin_born_pct,
         `Access to vechilce` = no_vehic
         )
```

################################################################################
################################################################################
#Building vulnerability index using PCA
################################################################################
################################################################################
```{r}
index_df_trnsf <- index_df |> 
  select(-c(1)) |>
  mutate(across(where(is.numeric), ~ log(. + 0.0000001)))

pca.ln  <- prcomp(index_df_trnsf, 
                  center = T,
                  scale = TRUE)

save(pca.ln, file="~/Documents/extreme_heat_cc/mansc_results/model_obj/pca.rda")
```

```{r}
#load model object and get all results
load("D:/cc_vulnerability/mansc_results/model_obj/pca.rda")

summary(pca.ln)

eigenvalues_ln <- matrix(pca.ln$sdev^2) #eigenvalues
perc_variance <- round(100*matrix(pca.ln$sdev^2/sum(pca.ln$sdev^2)),1) #variance

#Summary table 
eigenvalues_ln <- cbind(1:12, eigenvalues_ln, perc_variance) 
colum_ln <- c("Principal Component", "Eigenvalues", "Percent Variance")
eigenvalues_ln <- kable(eigenvalues_ln, col.names = colum_ln)
eigenvalues_ln 
```

#combine pc scores with original data
#Export PCA index values
```{r}
PCA_index <- as_tibble(pca.ln$x) #principal component scores for each variable

#combining with index_df dataframe
index_df_pc <- as_tibble((cbind(index_df, PCA_index)))
write_csv(index_df_pc, "D:/cc_vulnerability/mansc_results/index_vars/pca_indx.csv")
```

#Plots the proportion of variance explained by each component (scree plot)
```{r}
pve.ln <- pca.ln$sdev^2/sum(pca.ln$sdev^2) #proportion of variance explain by each component
 
#log-transformed data
fviz_eig(pca.ln, main = "Log - Transformed data",
         xlab = "Principal component",
         ylim = c(0,30)) 
```

#loading weights and visualization
```{r}
pca.ln.ld <- as.data.frame.matrix(pca.ln$rotation) ## rotation is the loadings variable within the pca output.
pca.ln.ld$chem <- row.names(pca.ln.ld)

pca.ln.ld |>
  gather(key = "PC", value = "Loading", -chem) |>
  as_tibble() |>
  filter(PC %in% c("PC1", "PC2")) %>% 
  mutate(PC = as.factor(PC),
         PC = fct_recode(PC, "PC 1" = "PC1",
         "PC 2" = "PC2")) |>
  ggplot(aes(x = chem, y = Loading)) + geom_col() +
  facet_wrap(~ PC) + theme_bw() + 
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  xlab("")+
  geom_hline(yintercept = 0, size = 0.2)
```

# PCA bi-plot
```{r}
autoplot(pca.ln, data = index_df_trnsf, size = 0.8, colour = 'royalblue', alpha = 0.5,
         loadings = TRUE, loadings.colour = 'orange',
         loadings.label = TRUE, loadings.label.repel = T, 
         loadings.label.size = 2.5, loadings.label.colour = 'black',
         main = "Principal Component Analysis Biplot")+
  theme_minimal()
```


################################################################################
################################################################################
#End of PCA
################################################################################
################################################################################

