---
title: "04.3_tsne"
output: pdf_document
date: "2024-08-27"
---

#load SDOH data
```{r}
load(paste0(data_path, "SDOH_final.RDA"))
```

#select required variables to work
```{r}
index_df<- dat_fin |>
  as_tibble()|>
  select(c(4, 16:27)) |>
  rename(`Non-Hispanic Black` = blk_pct,
         Hispanic = hisp_pct,
         Asian = asin_pct,
         `Alaska/Pacific-Islander` = alask_pacf_isl_pct,
         `Health insurance` = ins_pct,
         `Federal assistance` =ssi_snap_pct,
         `Households in poverty` = poverty_pct,
         `Un-employment` = un_empl_pct,
         `Language barrier` = langu_pct,
         `Single parent` =sing_prnt_pct,
         `Foregin born` = foregin_born_pct,
         `Access to vechilce` = no_vehic
         )
```

#data prep
```{r}
index_df_trnsf <- index_df |> 
  select(-c(1)) |>
  mutate(across(where(is.numeric), ~ log(. + 0.0000001)))

```

################################################################################
################################################################################
#t-SNE model
################################################################################
################################################################################
```{r}
# Define a range of parameters to test
perplexities <- c(5, 10, 20, 30, 40)
thetas <- c(0.2, 0.5, 0.8)
dims <- c(2, 3)

# Iterate over parameter combinations
results <- list()
for (p in perplexities) {
  for (t in thetas) {
    for (d in dims) {
      tsne_model <- Rtsne(index_df_trnsf,
                         check_duplicates = FALSE,
                         pca = TRUE,
                         perplexity = p,
                         theta = t,
                         dims = d)
      # Store or analyze the results
      results[[paste(p, t, d, sep = "_")]] <- tsne_model
    }
  }
}
#===============
# Create an empty list to store stress values
stress_values <- list()

# Extract stress values from each t-SNE model in `results`
for (config_name in names(results)) {
  tsne_model <- results[[config_name]]
  # Extract the stress value
  stress_value <- tsne_model$itercosts[length(tsne_model$itercosts)]
  # Store the stress value with its configuration
  stress_values[[config_name]] <- stress_value
}

# Convert the results to a data frame
stress_df <- data.frame(
  Configuration = names(stress_values),
  Stress = unlist(stress_values),
  stringsAsFactors = FALSE
)

# Optionally, split the configuration string into separate columns
stress_df <- tidyr::separate(stress_df, Configuration, into = c("Perplexity", "Theta", "Dims"), sep = "_")
#===============

tsne_model = Rtsne(index_df_trnsf,
                   check_duplicates = F, 
                   pca = T, 
                   perplexity = 40, 
                   theta = 0.8, 
                   dims = 3)

#variable importance
stress <- tsne_model$itercosts[length(tsne_model$itercosts)]

## getting the two dimension matrix
result_tsne <- as_tibble(tsne_model$Y) 

#save model and export result
save(tsne_model, file="D:/cc_vulnerability/mansc_results/model_obj/tsne.rda")
write_csv(result_tsne, "D:/cc_vulnerability/mansc_results/index_vars/tsne_indx.csv")

ggplot(result_tsne, aes(x=V1, y=V2)) +  
  geom_point(size=0.5, color="royalblue") +
  labs(x = "t-SNE-index_1", y = "t-SNE-index_2", title = "t-SNE") + 
  theme_minimal() + 
  scale_color_discrete(name = "Label")
```

#umap
```{r}
umap_df<- umap(index_df_trnsf)

umap_res<- as_tibble(umap_df$layout)

#save model and export result
save(umap_df, file="D:/cc_vulnerability/mansc_results/model_obj/umap.rda")
write_csv(umap_res, "D:/cc_vulnerability/mansc_results/index_vars/umap_indx.csv")
```


