---
title: "04.2_vulnerability_index_tsne_fa"
output: pdf_document
date: "2024-05-09"
---

#load SDOH data
```{r}
load(paste0(data_path, "SDOH_final.RDA"))
```

#select required variables to work
```{r}
index_df<- dat_fin |>
  as_tibble()|>
  select(c(4, 16:27)) |>
  rename(`Non-Hispanic Black` = blk_pct,
         Hispanic = hisp_pct,
         Asian = asin_pct,
         `Alaska/Pacific-Islander` = alask_pacf_isl_pct,
         `Health insurance` = ins_pct,
         `Federal assistance` =ssi_snap_pct,
         `Households in poverty` = poverty_pct,
         `Un-employment` = un_empl_pct,
         `Language barrier` = langu_pct,
         `Single parent` =sing_prnt_pct,
         `Foregin born` = foregin_born_pct,
         `Access to vechilce` = no_vehic
         )
```

#data prep
```{r}
index_df_trnsf <- index_df |> 
  select(-c(1)) |>
  mutate(across(where(is.numeric), ~ log(. + 0.0000001)))

```

#Factor analysis
```{r}
#check for Factor analysis using KMO criterion
index_df_corr <- cor(index_df_trnsf)
KMO(index_df_corr)

nfactors <- 12
nvariables <- dim(index_df_corr)[1]

factors <- fa(r = index_df_corr, 
              nfactors = nfactors, 
              rotate = "oblimin",
              scores = "regression", fm = "ml")
```

#Factor analysis - eigen values
```{r}
eigenvalues <- data.frame(factors$e.values)
colnames(eigenvalues) <- c("Values")
eigenvalues$Number <- 1:nrow(index_df_corr)

eigenvalues$RepresentedVariance <- NA
for (i in 1:nrow(index_df_corr)) {
    eigenvalues$RepresentedVariance[i] <- sum(eigenvalues$Values[1:i])/sum(eigenvalues$Values) * 
        100
}
eigenvalues$RepresentedVariance_text <- paste(round(eigenvalues$RepresentedVariance, 
    0), " %")

e1 <- ggplot(eigenvalues, aes(Number, y = Values), group = 1)+
  geom_bar(stat = "identity")+
  geom_line(aes(y = Values), group = 2)+
  xlab("Number [-]") +
  ylab("Eigenvalue [-]") + 
  geom_hline(aes(yintercept = 1), col = "red")  + 
  geom_text(aes(label = RepresentedVariance_text), nudge_y = 0.2)  + 
  ggtitle("Eigenvalues and explained Variance")  + 
  theme_minimal() + 
  scale_x_continuous(breaks = seq(1, 12, 1))

e1
```

#Factor analysis - extension
```{r}
loadings_mat <- as.data.frame(matrix(nrow = nvariables, ncol =nfactors))
loadings_mat$Variable <- colnames(index_df_trnsf)
for (i in 1:nfactors) {
  for (j in 1:nvariables) {
    loadings_mat[j, i] <- factors$loadings[j, i]  
  }
}
colnames(loadings_mat) <- c("Factor1", "Factor2", "Factor3", 
                            "Factor4", "Factor5", "Factor6",
                            "Factor7", "Factor8", "Factor9", 
                            "Factor10", "Factor11", "Factor12",
                            "Variable")
loadings_mat_gather <- loadings_mat %>% gather("Factor", "Value", 1:nfactors)
```

#Factor analysis: Directionality of variables by 2 factors
```{r}
loadings_mat$Zero <- 0
f1 <- ggplot(loadings_mat, aes(Zero, Zero))  + 
  geom_segment(aes(xend = Factor1, yend=Factor2), 
                        arrow = arrow(length = unit(0.3,"cm")), col="red")  + 
  geom_text(aes(x = Factor1, y = Factor2, label = Variable))    +
  geom_segment(aes(xend = 1, yend=0), 
                        arrow = arrow(length = unit(0.3,"cm")), col="black") + 
  geom_segment(aes(xend = 0, yend=1), 
                        arrow = arrow(length = unit(0.3,"cm")), col="black") +
  xlab("Factor 1") +
  ylab("Factor 2") +
  ggtitle("Factor Loadings") +
  theme_bw(base_size=12) +
  theme(legend.position="none")

f1
```


#Factor analysis: Loadings (final figure)
```{r}
loadings_mat_gather$Factor <- factor(loadings_mat_gather$Factor, 
                                     levels = paste0("Factor", 1:12))

g1 <- ggplot(loadings_mat_gather, aes(Variable, abs(Value)))  + 
  facet_wrap(~ Factor, nrow=1)+
  geom_bar(stat="identity")+
  coord_flip() +
  xlab("Variable") +
  ylab("Factor Loading") +
  ggtitle("Factors") +
  scale_y_continuous(breaks = c(0.2, 0.8), limits = c(0, 1))+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12, face="bold"))+
  theme(plot.title = element_text(size=12))+
  theme_minimal(base_size=12)

g1
```

#factor analysis: index
```{r}
factor_scores <- factor.scores(index_df_trnsf, factors)
FA_index <- as_tibble(factor_scores$scores[, 1:2])
```


################################################################################
################################################################################
#t-SNE model
################################################################################
################################################################################
```{r}
tsne_model = Rtsne(index_df_trnsf,
                   check_duplicates = F, 
                   pca = T, 
                   perplexity = 30, 
                   theta = 0.5, 
                   dims = 2)

#variable importance
stress <- tsne_model$itercosts[length(tsne_model$itercosts)]

## getting the two dimension matrix
result_tsne <- as_tibble(tsne_model$Y)  

ggplot(result_tsne, aes(x=V1, y=V2)) +  
  geom_point(size=0.5, color="royalblue") +
  labs(x = "t-SNE-index_1", y = "t-SNE-index_2", title = "t-SNE") + 
  theme_minimal() + 
  scale_color_discrete(name = "Label")
```

#PCA for comparision
```{r}
pca_model  <- prcomp(index_df_trnsf, center = T, scale = TRUE)

result_pca <- tibble(PC1 = pca_model$x[, 1],
                     PC2 = pca_model$x[, 2])

ggplot(result_pca, aes(x=PC1, y=PC2)) +  
  geom_point(size=2) +
  labs(x = "", y = "", title = "PCA") + 
  theme_bw() 
```

#umap
```{r}
library(umap)
x<- umap(vul_index[3:14,])
umap_df<- umap(x_df)

umap_res<- as_tibble(umap_df$layout)

write_csv(umap_res, file = "~/Documents/extreme_heat_cc/results/umap_result.csv")
```


