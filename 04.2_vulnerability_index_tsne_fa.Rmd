---
title: "04.2_vulnerability_index_tsne_fa"
output: pdf_document
date: "2024-05-09"
---

#load SDOH data
```{r}
load(paste0(data_path, "SDOH_final.RDA"))
```

#select required variables to work
```{r}
index_df<- dat_fin |>
  as_tibble()|>
  select(c(4, 16:27)) |>
  rename(`Non-Hispanic Black` = blk_pct,
         Hispanic = hisp_pct,
         Asian = asin_pct,
         `Alaska/Pacific-Islander` = alask_pacf_isl_pct,
         `Health insurance` = ins_pct,
         `Federal assistance` =ssi_snap_pct,
         `Households in poverty` = poverty_pct,
         `Un-employment` = un_empl_pct,
         `Language barrier` = langu_pct,
         `Single parent` =sing_prnt_pct,
         `Foregin born` = foregin_born_pct,
         `Access to vechilce` = no_vehic
         )
```

#data prep
```{r}
index_df_trnsf <- index_df |> 
  select(-c(1,5,9)) |>
  mutate(across(where(is.numeric), ~ log(. + 0.0000001)))

```

#Factor analysis
```{r}
#check for Factor analysis using KMO criterion
index_df_corr <- cor(index_df_trnsf)
KMO(index_df_corr)

nfactors <- 10
nvariables <- dim(index_df_corr)[1]

factors <- fa(r = index_df_corr, nfactors = nfactors, rotate = "oblimin")
```

#Factor analysis - eigen values
```{r}
eigenvalues <- data.frame(factors$e.values)
colnames(eigenvalues) <- c("Values")
eigenvalues$Number <- 1:nrow(index_df_corr)

eigenvalues$RepresentedVariance <- NA
for (i in 1:nrow(index_df_corr)) {
    eigenvalues$RepresentedVariance[i] <- sum(eigenvalues$Values[1:i])/sum(eigenvalues$Values) * 
        100
}
eigenvalues$RepresentedVariance_text <- paste(round(eigenvalues$RepresentedVariance, 
    0), " %")

e1 <- ggplot(eigenvalues, aes(Number, y = Values), group = 1)+
  geom_bar(stat = "identity")+
  geom_line(aes(y = Values), group = 2)+
  xlab("Number [-]") +
  ylab("Eigenvalue [-]") + 
  geom_hline(aes(yintercept = 1), col = "red")  + 
  geom_text(aes(label = RepresentedVariance_text), nudge_y = 0.2)  + 
  ggtitle("Eigenvalues and explained Variance")  + 
  theme_bw() + 
  scale_x_continuous(breaks = seq(1, 10, 1))

e1
```

#Factor analysis - extension
```{r}
loadings_mat <- as.data.frame(matrix(nrow = nvariables, ncol =nfactors))
loadings_mat$Variable <- colnames(index_df_trnsf)
for (i in 1:nfactors) {
  for (j in 1:nvariables) {
    loadings_mat[j, i] <- factors$loadings[j, i]  
  }
}
colnames(loadings_mat) <- c("Factor1", "Factor2", "Factor3", 
                            "Factor4", "Factor5", "Factor6",
                            "Factor7", "Factor8", "Factor9", "Factor10",
                            "Variable")
loadings_mat_gather <- loadings_mat %>% gather("Factor", "Value", 1:nfactors)
```

#Factor analysis: Directionality of variables by 2 factors
```{r}
loadings_mat$Zero <- 0
f1 <- ggplot(loadings_mat, aes(Zero, Zero))  + 
  geom_segment(aes(xend = Factor1, yend=Factor2), 
                        arrow = arrow(length = unit(0.3,"cm")), col="red")  + 
  geom_text(aes(x = Factor1, y = Factor2, label = Variable))    +
  geom_segment(aes(xend = 1, yend=0), 
                        arrow = arrow(length = unit(0.3,"cm")), col="black") + 
  geom_segment(aes(xend = 0, yend=1), 
                        arrow = arrow(length = unit(0.3,"cm")), col="black") +
  xlab("Factor 1") +
  ylab("Factor 2") +
  ggtitle("Factor Loadings") +
  theme_bw(base_size=12) +
  theme(legend.position="none")

f1
```

#Factor analysis: Loadings (final figure)
```{r}
g1 <- ggplot(loadings_mat_gather, aes(Variable, abs(Value), fill=Value))  + 
  facet_wrap(~ Factor, nrow=1)+
  geom_bar(stat="identity")+
  coord_flip()+
  scale_fill_gradient2(name = "Loading", 
                       high = "blue", mid = "white", low = "red", 
                       midpoint=0, guide=F) +
  xlab("Variable") +
  ylab("Factor Loading") +
  ggtitle("Factors") +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12, face="bold"))+
  theme(plot.title = element_text(size=12))+
  theme_bw(base_size=12)

g1
```

#Factor analysis final figure
```{r}
corr_reduced <- index_df_corr
for (i in 1: nvariables) {
  corr_reduced[i, i] <- factors$communality[i]
}

corr_melt <- corr_reduced %>% melt()
corr_melt <- corr_melt[order(corr_melt$Var2), ]

p1 <- ggplot(corr_melt, aes(Var1, Var2, fill=abs(value))) +
  geom_tile()  +
  geom_text(aes(label = round(value, 2)), size=4) +
  theme_bw(base_size=10) +
  theme(axis.text.x = element_text(angle = 90), 
        axis.title.x=element_blank(), 
        axis.title.y=element_blank(), 
        plot.margin = unit(c(3, 1, 0, 0), "mm")) +
  scale_fill_gradient(low="white", high="red") + guides(fill=F) 

p2 <- ggplot(loadings_mat_gather, aes(Variable, abs(Value), fill=Factor)) +
  geom_bar(stat="identity") + coord_flip() +
  ylab("Factor Loading") +
  theme_bw(base_size=12) +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(), 
        plot.margin = unit(c(3, 5, 20, 3), "mm"))

grid.arrange(p1, p2, ncol=2, widths=c(2, 1)) #side-by-side, matrix gets more space
```

################################################################################
################################################################################
#t-SNE model
################################################################################
################################################################################
```{r}
tsne_model = Rtsne(index_df_trnsf,
                   check_duplicates = F, 
                   pca = T, 
                   perplexity = 30, 
                   theta = 0.5, 
                   dims = 2)

## getting the two dimension matrix
result_tsne <- as_tibble(tsne_model$Y)  

ggplot(result_tsne, aes(x=V1, y=V2)) +  
  geom_point(size=2) +
  labs(x = "", y = "", title = "t-SNE") + 
  theme_bw() + 
  scale_color_discrete(name = "Label")
```

#PCA for comparision
```{r}
pca_model  <- prcomp(index_df_trnsf, center = T, scale = TRUE)

result_pca <- tibble(PC1 = pca_model$x[, 1],
                     PC2 = pca_model$x[, 2])

ggplot(result_pca, aes(x=PC1, y=PC2)) +  
  geom_point(size=2) +
  labs(x = "", y = "", title = "PCA") + 
  theme_bw() 
```


