---
title: "04.2_vulnerability_index_AE"
author: "Puvvula"
date: "2024-04-25"
output: pdf_document
---

#load SDOH data
```{r}
load(paste0(data_path, "SDOH_final.RDA"))
```

#select required variables to work
```{r}
index_df<- dat_fin |>
  as_tibble()|>
  select(c(4, 16:27)) |>
  rename(`Non-Hispanic Black` = blk_pct,
         Hispanic = hisp_pct,
         Asian = asin_pct,
         `Alaska/Pacific-Islander` = alask_pacf_isl_pct,
         `Health insurance` = ins_pct,
         `Federal assistance` =ssi_snap_pct,
         `Households in poverty` = poverty_pct,
         `Un-employment` = un_empl_pct,
         `Language barrier` = langu_pct,
         `Single parent` =sing_prnt_pct,
         `Foregin born` = foregin_born_pct,
         `Access to vechilce` = no_vehic
         )
```

# data prep
```{r}
model_df<- index_df |>
  select(-c(1,5,9))
model_mat<- model_df |> as.matrix()

#split train and test
c(train, val, test) %<-% train_val_test_split(df = model_df, 
                                              train_ratio = 0.6, 
                                              val_ratio = 0.2, 
                                              test_ratio = 0.2)
```

# Modeling

## Data Matrix Creation
```{r}
train_mat <- train |> as.matrix()

val_mat <- val |> as.matrix()

test_mat <- test |> as.matrix()
```


## Encoder and Decoder Layer Setup
```{r}
input_layer <- layer_input(shape = c(10)) #10 input variables

n1 <- 2 #hidden layer
n2 <- n1 #
n3 <- 10 #output layer should have exact same number as input layer

encoder <- 
  input_layer %>% 
  layer_dense(units = n1, activation = "linear")  # dimensions of final encoding layer

decoder <- encoder %>% 
  layer_dense(units = n2, activation = "linear") %>% 
  layer_dense(units = n3, activation = "linear")  # dimension of original variable
```

## Compilation and Training
```{r}
ae_model <- keras_model(inputs = input_layer, outputs = decoder)

ae_model %>% 
  compile(loss = "mean_absolute_error",
          optimizer = "adam",
          metrics = c("mean_squared_error"))

summary(ae_model)
```

#train the model.
```{r}
history <- ae_model %>% 
  keras::fit(train_mat,
             train_mat,
             epochs = 20,
             shuffle = T,
             validation_data = list(val_mat, val_mat))

plot(history)
```

# Results: Use encoder model and predict reduced dimensions.
```{r}
save_model_weights_hdf5(ae_model, filepath = "./models/ae_weights.hdf5")

encoder_model <- keras_model(inputs = input_layer, outputs = encoder)
encoder_model %>% load_model_weights_hdf5(filepath = "./models/ae_weights.hdf5", 
                                          skip_mismatch = T, 
                                          by_name = T)
```

#export encoder that contain reduced dimensions
```{r}
reduced_predictions <- encoder_model |> 
  predict(model_mat) |> #update this with full data frame
  as_tibble()

write_csv(reduced_predictions, paste0(result_path, "AE_index.csv"))
```


```{r}
ggplot(reduced_predictions, aes(x = V1, y = V2)) + 
  geom_point() + 
  theme_bw()
```
