---
title: "05.1_future_cc"
author: "Puvvula"
date: "2024-05-15"
output: pdf_document
---

#updated in April 2025

```{r}
library(pacman)
pacman::p_load(tidyverse, tidycensus, janitor, glue, httr, terra, fs, httr, 
               ncdf4, raster, stringr, sf, broom, biscale,
               tigris, cowplot, ggpattern)
```

#State shapefile
```{r}
conus_sf<- tigris::states(cb=F) |>
  filter(!STUSPS %in% c("AK", "HI", "GU", "VI", "MP", "AS", "PR"))
```

```{r}
# Define file paths
raster_files <- list(
  mid_cen_lo_ems  = "D:/cc_vulnerability/cimp6_ensbl_data/JJA_Days_Above_95F_Count_2041_2060_low_emission.tif",
  mid_cen_hi_ems  = "D:/cc_vulnerability/cimp6_ensbl_data/JJA_Days_Above_95F_Count_2041_2060_high_emission.tif",
  late_cen_lo_ems = "D:/cc_vulnerability/cimp6_ensbl_data/JJA_Days_Above_95F_Count_2081_2100_low_emission.tif",
  late_cen_hi_ems = "D:/cc_vulnerability/cimp6_ensbl_data/JJA_Days_Above_95F_Count_2081_2100_high_emission.tif"
)

# Load one raster to get CRS
template_raster <- raster(raster_files[[1]])
raster_crs <- crs(template_raster)

# Transform and union CONUS shapefile
conus_sf <- st_transform(conus_sf, raster_crs) |> st_union()
conus_sp <- as(conus_sf, "Spatial")

# Define processing function
clip_and_crop_raster <- function(path, conus_sp) {
  r <- raster(path)
  r_masked <- mask(r, conus_sp)
  r_cropped <- crop(r_masked, conus_sp)
  return(r_cropped)
}

# Process all rasters
processed_rasters <- raster_files |> 
  map(~ clip_and_crop_raster(.x, conus_sp)) |> 
  set_names(names(raster_files))

#clean env
rm(conus_sf, conus_sp, raster_crs, raster_files, template_raster)
gc()
```


#transform to df format and break into categories
```{r}
# Correct number of breakpoints for 3 groups = 4 breakpoints
mid_breaks <- c(-Inf, 91, 969, Inf)
late_breaks <- c(-Inf, 469, 1369, Inf)

# Function
raster_to_df <- function(r, breaks) {
  df <- as.data.frame(r, xy = TRUE)
  df |>
    rename(anomaly_frequency = 3) |>
    drop_na(anomaly_frequency) |>
    mutate(
      anomaly_quartile = cut(anomaly_frequency,
                             breaks = breaks,
                             labels = c("Q1", "Q2", "Q3"),
                             include.lowest = TRUE)
    )
}

# Split rasters
mid_rasters <- processed_rasters[grep("^mid_", names(processed_rasters))]
late_rasters <- processed_rasters[grep("^late_", names(processed_rasters))]

# Apply function
mid_df <- map(mid_rasters, ~raster_to_df(.x, mid_breaks))
late_df <- map(late_rasters, ~raster_to_df(.x, late_breaks))

# Optionally combine
all_df <- c(mid_df, late_df)

```

#prelim plots
#State shapefile
```{r}
state_shp<- tigris::states(cb=F) |>
  filter(!STUSPS %in% c("AK", "HI", "GU", "VI", "MP", "AS", "PR"))
```


##Future warming - updated april 17
```{r}
current_cc<- 
  ggplot()+
  geom_raster(data = all_df$late_cen_hi_ems, 
              aes(x = x, y = y, 
                  fill = anomaly_quartile))+
  geom_sf(data = state_shp, 
          aes(geometry = geometry), 
          fill= NA, color = "white", 
          size = 12,  show.legend = F)+
  scale_fill_manual(values=
  quartile_colors <- c(
  "Q1" = "#4169E1",  # Royal Blue
  "Q2" = "#20B2AA",  # Light Sea Green (turquoise)
  "Q3" = "#DC143C"   # Crimson
  )) +
  theme_void() +
  theme(legend.position = "bottom")+
  guides(fill = guide_legend("Temperature anomalies (JJA)"))

ggsave(current_cc, 
       file="D:/cc_vulnerability/results_apr_2025/late_cen_hi_ems.tiff",
       width = 12,height = 10,
       dpi=300,
       bg="white")
```


#categorize future climate anomalies data retaining in raster format
```{r}
# Define breaks
mid_breaks <- c(-Inf, 91, 969, Inf)
late_breaks <- c(-Inf, 469, 1369, Inf)

# Function to classify raster into quantiles
raster_to_quantiles <- function(r, breaks) {
  # Apply 'cut' to classify values into categories
  classified_raster <- cut(r[], breaks = breaks, labels = c("Q1", "Q2", "Q3"), include.lowest = TRUE)
  
  # Convert to raster object with same extent and resolution as input raster
  result_raster <- raster(r)
  result_raster[] <- as.numeric(classified_raster)  # Assign numeric categories
  
  return(result_raster)
}

# Process 'mid_' rasters
mid_rasters <- processed_rasters[grep("^mid_", names(processed_rasters))]
mid_rasters_quantized <- lapply(mid_rasters, raster_to_quantiles, breaks = mid_breaks)

# Process 'late_' rasters
late_rasters <- processed_rasters[grep("^late_", names(processed_rasters))]
late_rasters_quantized <- lapply(late_rasters, raster_to_quantiles, breaks = late_breaks)

# Combine the processed rasters if needed
all_quantized_rasters <- c(mid_rasters_quantized, late_rasters_quantized)

# Remove all objects except for 'all_quantized_rasters' and 'processed_rasters'
rm(list = setdiff(ls(), c("all_quantized_rasters", "processed_rasters")))

# Loop over each raster in 'all_quantized_rasters' and assign it to the global environment in terra format
for (raster_name in names(all_quantized_rasters)) {
  # Convert the raster to terra format
  terra_raster <- terra::rast(all_quantized_rasters[[raster_name]])
  
  # Assign the terra raster to the global environment with the same name
  assign(raster_name, terra_raster, envir = .GlobalEnv)
}
```


#bivariate mapping future warming + pediatric vulnerability
#final version of vulnerability index - created on June 3, 2024
```{r}
tracts_conus <- st_read("D:/cc_vulnerability/tracts_shp/tracts_conus_shape.shp") |>
  dplyr::select(c(1, 5))

ped_indx <- read_csv("D:/cc_vulnerability/mansc_results/index_vars/all_indicies_combined.csv") |>
  dplyr::select(c(1, 14)) |>
  right_join(tracts_conus, by= "geoid") 

# First, make sure ped_indx is an sf object with geometry
if (!("sf" %in% class(ped_indx))) {
  # If it lost its sf class during the join, convert it back
  ped_indx <- st_as_sf(ped_indx)
}

# Set the CRS to NAD83 (EPSG:4269)
ped_indx <- st_set_crs(ped_indx, 4269)  # EPSG code for NAD83
```

#Harmonize and join pediatric indicies and future warming data layers 
```{r}
# Now transform to match the raster's CRS (WGS84)
ped_indx_transformed <- st_transform(ped_indx, crs(late_cen_hi_ems)) #<-

# Convert to a terra vector object
vector_terra <- vect(ped_indx_transformed)

# Choose the appropriate column (adjust based on the output above)
field_to_use <- names(vector_terra)[2]  # Change index as needed

# Rasterize the vector data to match the raster's resolution
result_raster <- rasterize(vector_terra, late_cen_hi_ems, field=field_to_use) #<-

# Create a multi-layer raster by stacking both layers
combined_raster <- c(late_cen_hi_ems, result_raster) #<-

# Set appropriate names for the layers
names(combined_raster) <- c("temperature_anomalies", "PC1")
```

```{r}
# Create a data frame from the combined raster that has both variables
bivariate_raster_df <- as.data.frame(combined_raster, xy = TRUE) |>
  filter(!is.na(PC1)) |>
  mutate(PC1_level = ntile(PC1, 3),
         bi_class = paste(temperature_anomalies, PC1_level, sep = "-")
         )
```

#bivariate plotting - CONUS
#nclimgrid anomalies and PC1
```{r}
map<- ggplot()+
  geom_raster(data = bivariate_raster_df, 
                aes(x = x, y = y, fill = bi_class), 
                show.legend = F)+
  geom_sf(data = state_shp, 
            aes(geometry = geometry), 
            fill= NA, color = "white",
            size = 12,  
            show.legend = F)+
  labs(x = NULL, y = NULL)+
    bi_scale_fill(pal = "DkBlue2", dim = 3)+
    theme_void() +
    theme(legend.position = "none")+
    bi_theme()


legend <- bi_legend(pal = "DkBlue2",
                    dim = 3,
                    xlab = "Pediatric vulnerability",
                    ylab = "Tmax anomalies",
                    size = 10)

map_fin<- ggdraw() +
    draw_plot(map, 0, 0, 1, 1) +
    draw_plot(legend, 0.125, 0.1, 0.2, 0.2)
```


```{r}
tiff(
  filename = "D:/cc_vulnerability/results_apr_2025/bivariate_late_cen_hi_ems.tiff",
  width = 12, height = 10, units = "in", 
  res = 300, compression = "lzw"  # LZW compression uses less memory
)
print(map_fin)
dev.off()
```




